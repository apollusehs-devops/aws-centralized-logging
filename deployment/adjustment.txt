

Security
1. ES wasn't place into defined vpc but under public 

Other
1. Password was generated by Cognito, but we need to input instead due to without Cognito Userpools 
2. S3 buket for release bucket
3. Need to create key pair before launch template 



#aws ec2 describe-instances --instance-ids $(aws autoscaling describe-auto-scaling-instances --output text --query "AutoScalingInstances[?AutoScalingGroupName=='TeABear-AutoScalingGroup3-UXKZGX34BCHQ'].InstanceId" --profile sin) --query "Reservations[].Instances[].PrivateIpAddress" --profile sin

#aws es describe-elasticsearch-domain-config --domain-name centralizedlogging --profile sin|jq '.DomainConfig.AccessPolicies.Options' |sed -e 's/\\//g;s/^"//;s/"$//'
# aws es describe-elasticsearch-domain-config --domain-name centralizedlogging --profile sin|jq '.DomainConfig.AccessPolicies.Options' |sed -e 's/\\//g;s/^"//;s/"$//'|sed -e 's/"aws:SourceIp".*}}},/"aws:SourceIp":'"$X"'}}},/g'|jq

#aws ec2 describe-instances --instance-ids $(aws autoscaling describe-auto-scaling-instances --output text --query "AutoScalingInstances[?AutoScalingGroupName=='TeABear-AutoScalingGroup3-UXKZGX34BCHQ'].InstanceId" --profile sin) --query "Reservations[].Instances[].PrivateIpAddress" --profile sin |tr '\n' ' '


             # Modify access policy for ElasticSearch
              export NGINX_NODE_IPS=`aws ec2 describe-instances --instance-ids \
                $(aws autoscaling describe-auto-scaling-instances --output text \
                --query "AutoScalingInstances[?AutoScalingGroupName=='${NginxAutoscalingGroup}'].InstanceId") \
                --query "Reservations[].Instances[].PublicIpAddress" |tr '\n' ' '`
              aws es update-elasticsearch-domain-config --domain-name ${ESDomain} --access-policies '`aws es describe-elasticsearch-domain-config --domain-name centralizedlogging |jq '.DomainConfig.AccessPolicies.Options' |sed -e 's/\\//g;s/^"//;s/"$//'|sed -e 's/"aws:SourceIp".*}}},/"aws:SourceIp":'"$NGINX_NODE_IPS"'}}},/g'|jq`'

export NGINX_NODE_IPS=`aws ec2 describe-instances --region ap-southeast-1 --instance-ids \
  $(aws autoscaling describe-auto-scaling-instances --region ap-southeast-1 --output text \
  --query "AutoScalingInstances[?AutoScalingGroupName=='test-nginx5-nginx-asg'].InstanceId") \
  --query "Reservations[].Instances[].PublicIpAddress" |tr '\n' ' '`

export NEW_POLICY=$(aws es describe-elasticsearch-domain-config --region ap-southeast-1 \
  --domain-name centralizedlogging |\
  jq '.DomainConfig.AccessPolicies.Options' |\
  sed -e 's/\\//g;s/^"//;s/"$//'|sed -e 's/"aws:SourceIp".*}}},/"aws:SourceIp":'"$NGINX_NODE_IPS"'}}},/g')
aws es update-elasticsearch-domain-config --region ap-southeast-1 --domain-name cltest \
  --access-policies "$NEW_POLICY"

sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/cert.key -out /etc/nginx/cert.crt    -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=www.example.com"          
 

"ec2:DescribeInstances",
"autoscaling:DescribeAutoScalingGroups" 